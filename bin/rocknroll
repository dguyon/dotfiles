#!/usr/bin/env zsh

setopt extendedglob

if ! type 'brew' > /dev/null; then
  echo '--> Installing Homebrew'
  ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
fi

echo '--> Add extras Homebrew formulas'
brew tap homebrew/dupes
brew tap homebrew/homebrew-php

echo '--> Make sure Homebrew is up to date'
brew update

echo '--> Upgrade installed formulas'
brew upgrade --all

echo '--> BREW ALL THE THINGS!'
brew install git --with-brewed-curl --with-brewed-openssl
brew install bash
brew install zsh
brew install the_silver_searcher
brew install coreutils
brew install curl
brew install wget
brew install midnight-commander
brew install mtr
brew install htop-osx
brew install homebrew/dupes/make --with-default-names
brew install gnu-sed --with-default-names
brew install gnu-tar --with-default-names
brew install gnu-which --with-default-names
brew install md5sha1sum
brew install mysql
brew install pv
brew install rsync
brew install ssh-copy-id
brew install gettext && brew link gettext --force
brew install openssl && brew link openssl --force
brew install docker
brew install docker-compose
brew install heroku-toolbelt

# Nginx
brew install nginx --with-spdy

# PHP
brew install php70 --with-imap --with-homebrew-curl --with-homebrew-libressl --with-homebrew-libxml2 --with-homebrew-libxslt --without-apache --without-fpm --without-ldap;
brew install php70-intl;
brew install php70-mcrypt;
brew install --HEAD php70-memcached;
brew install --HEAD php70-redis;
brew install php70-pdo-dblib;
brew install --HEAD php70-yaml;

# PHP Conf
echo "date.timezone = 'Europe/Paris'" >> /usr/local/etc/php/7.0/php.ini
echo "phar.readonly = Off" >> /usr/local/etc/php/7.0/php.ini

if ! type 'composer' > /dev/null; then
  curl -sSL https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
else
  composer self-update --clean-backups
fi

composer global require fabpot/php-cs-fixer

# Python
brew install python --with-brewed-openssl
pip install -U setuptools pip fabric autopep8

# Ruby
brew install ruby
gem update --system
gem pristine --all --only-executables

# Go
brew install go --with-cc-common

# node.js
brew install node --with-openssl --without-npm
mkdir -p "$HOME/.npm-packages"

if ! type 'npm' > /dev/null; then
    curl -sSL https://www.npmjs.com/install.sh | sh
fi

npm install -g npm@2
npm install -g gulp@latest
npm install -g speedtest@latest

echo '--> Installing Cask'
brew tap Caskroom/cask

echo '--> Add extras Cask formulas'
brew tap caskroom/versions
brew tap caskroom/fonts

echo '--> Make sure Cask is up to date'
brew cask update

echo '--> CASK ALL THE THINGS!'
brew cask install xquartz
brew cask install virtualbox
brew cask install vagrant
brew cask install appcleaner
brew cask install font-ubuntu
brew cask install vlc
brew cask install google-chrome
brew cask install google-chrome-canary
brew cask install firefox
brew cask install firefoxdeveloperedition
brew cask install iterm2
brew cask install libreoffice
brew cask install onyx
brew cask install miro-video-converter

echo '--> Cleanup both Homebrew and Cask formulas'
brew cask cleanup
brew cleanup

# slimzsh
if [ -d "$HOME/.slimzsh" ]; then
  echo '--> Updating slimzsh'
  cd "$HOME/.slimzsh/"
  git pull --prune
  git submodule update --init --recursive
  cd -
else
  echo '--> Installing slimzsh'
  git clone --recursive https://github.com/changs/slimzsh.git "$HOME/.slimzsh"
fi

echo '--> Symlinking dot files'
for dotfile in "${ZDOTDIR:-$HOME}"/.dotfiles/.{aliases,curlrc,gemrc,npmrc,gitconfig,gitignore_global,zprofile,zlogout,zshrc}; do
  ln -sf "$dotfile" "${ZDOTDIR:-$HOME}/${dotfile:t}" 2> /dev/null
done

exec $SHELL
